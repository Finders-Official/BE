# ========================================
# Finders API - 로컬 개발 환경
# ========================================
# 사용법:
#   1. MySQL만 실행 (Spring은 IDE에서):
#      docker compose up mysql -d
#      ./gradlew bootRun
#
#   2. 전체 실행 (MySQL + Spring):
#      docker compose up -d
#
#   3. 종료:
#      docker compose down
#
#   4. 데이터 초기화:
#      docker compose down -v
# ========================================

services:
  # ========================================
  # MySQL Database
  # ========================================
  mysql:
    image: mysql:8.0
    container_name: finders-mysql
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: finders
      MYSQL_USER: finders
      MYSQL_PASSWORD: finders123
      TZ: Asia/Seoul
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - finders-network

  # ========================================
  # Spring Boot Backend (선택적)
  # ========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: finders-backend
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: local
      # DB - Docker 내부 네트워크 사용
      DB_URL: jdbc:mysql://mysql:3306/finders?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
      DB_USER: finders
      DB_PASSWORD: finders123
      # Kakao API (.env에서 읽음)
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
      KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}
      # JWT (.env에서 읽음)
      JWT_SECRET: ${JWT_SECRET}
      # GCP (.env에서 읽음)
      GCS_BUCKET: ${GCS_BUCKET}
      VISION_ENABLED: ${VISION_ENABLED:-false}
    networks:
      - finders-network
    profiles:
      - full  # docker compose --profile full up 으로 실행

volumes:
  mysql-data:

networks:
  finders-network:
    driver: bridge
