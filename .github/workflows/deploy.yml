name: Finders CD (Deploy to Prod)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: asia-northeast3-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/finders-docker/api
  CONTAINER_NAME: finders-api

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-prod
      cancel-in-progress: true
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build without Test
        # CI에서 이미 테스트를 통과했다고 믿고, 배포 속도를 위해 테스트는 건너뜁니다.
        run: ./gradlew build -x test

      # 4. GCP 인증 (Workload Identity Federation)
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      # 5. Google Cloud SDK 설정
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'

      - name: Load Deploy Config from Terraform
        run: |
          gcloud storage cp gs://finders-terraform-state/deploy-config.json /tmp/deploy-config.json
          echo "GCE_NAME=$(jq -r .gce_name /tmp/deploy-config.json)" >> $GITHUB_ENV
          echo "GCE_ZONE=$(jq -r .gce_zone /tmp/deploy-config.json)" >> $GITHUB_ENV

      # 6. Artifact Registry 인증
      - name: Authenticate to Artifact Registry
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev

      # 7. Docker 이미지 빌드 및 Artifact Registry 푸시
      - name: Build and Push to Artifact Registry
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest

      - name: Refresh Environment Variables from Secret Manager
        run: |
          gcloud secrets versions access latest \
            --project='${{ secrets.GCP_PROJECT_ID }}' \
            --secret='finders-prod-config' \
          | jq -r 'to_entries[] | "\(.key | ascii_upcase)=\(.value)"' \
          > .env.prod

          gcloud compute scp .env.prod ${{ env.GCE_NAME }}:~/.env.prod \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet

          gcloud compute ssh ${{ env.GCE_NAME }} \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="
              sudo mv ~/.env.prod /projects/Finders/BE/.env.prod
              sudo chmod 600 /projects/Finders/BE/.env.prod
            "

      # 8. Blue-Green 배포 실행 (secrets are fetched from GCP Secret Manager by startup script)
      - name: 'Deploy to GCE via IAP (Blue-Green)'
        run: |
          # A. 서버 디렉토리 생성
          gcloud compute ssh ${{ env.GCE_NAME }} \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="sudo mkdir -p /projects/Finders/BE"

          # B-1. docker-compose.infra.yml 전송
          gcloud compute scp docker-compose.infra.yml ${{ env.GCE_NAME }}:~/docker-compose.infra.yml \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet

          # B-2. docker-compose.prod.yml 전송
          gcloud compute scp docker-compose.prod.yml ${{ env.GCE_NAME }}:~/docker-compose.prod.yml \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet

          # C. Blue-Green 배포 명령어 실행
          gcloud compute ssh ${{ env.GCE_NAME }} \
            --zone=${{ env.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="
              sudo mv ~/docker-compose.infra.yml /projects/Finders/BE/docker-compose.infra.yml
              sudo mv ~/docker-compose.prod.yml /projects/Finders/BE/docker-compose.prod.yml

              cd /projects/Finders/BE
              DC='sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml'

              sudo docker network create finders-network || true
              # .env.prod is generated by GCP Secret Manager via Terraform startup script

              # ── 현재 활성 슬롯 감지 ──
              ACTIVE_SLOT=\$(\$DC ps --format json 2>/dev/null | jq -sr '.[].Service' 2>/dev/null | grep -E 'prod-blue|prod-green' | head -1)
              ACTIVE_SLOT=\${ACTIVE_SLOT:-none}

              if [[ \"\$ACTIVE_SLOT\" == 'prod-blue' ]]; then
                GREEN_SLOT='green'
                BLUE_SLOT='blue'
              else
                GREEN_SLOT='blue'
                BLUE_SLOT='green'
              fi
              echo \"현재: \$ACTIVE_SLOT / 새 슬롯: prod-\$GREEN_SLOT / 기존: prod-\$BLUE_SLOT\"

              # ── 최초 배포 시 베이스 인프라 시작 ──
              if [[ \"\$ACTIVE_SLOT\" == 'none' ]]; then
                echo '최초 배포: 베이스 인프라 시작'
                \$DC up -d traefik cloudflared
                sleep 10
              fi

              \$DC pull
              echo \"Green 슬롯(prod-\$GREEN_SLOT) 시작\"
              \$DC --profile \$GREEN_SLOT up -d

              # ── Health Check (Docker 네이티브 health status) ──
              GREEN_CONTAINER=\$(\$DC ps --format json 2>/dev/null | jq -sr \".[] | select(.Service == \\\"prod-\$GREEN_SLOT\\\") | .Name\")
              echo \"Health Check 시작... (container: \$GREEN_CONTAINER)\"

              for i in {1..36}; do
                STATUS=\$(sudo docker inspect --format='{{.State.Health.Status}}' \"\$GREEN_CONTAINER\" 2>/dev/null || echo 'not_found')

                if [[ \"\$STATUS\" == 'healthy' ]]; then
                  echo \"✅ Green 슬롯 정상 확인! (\${i}번째 체크)\"
                  break
                fi

                if [[ \"\$STATUS\" == 'unhealthy' ]]; then
                  echo '❌ Container unhealthy - 롤백 진행'
                  sudo docker inspect --format='{{range .State.Health.Log}}{{.Output}}{{end}}' \"\$GREEN_CONTAINER\" 2>/dev/null || true
                  sudo docker logs --tail 80 \"\$GREEN_CONTAINER\" 2>/dev/null || true
                  sudo docker stop \"\$GREEN_CONTAINER\" 2>/dev/null && sudo docker rm -f \"\$GREEN_CONTAINER\" 2>/dev/null
                  exit 1
                fi

                if [ \$i -eq 36 ]; then
                  echo '❌ Health Check 타임아웃 (180s) - 롤백 진행'
                  sudo docker logs --tail 80 \"\$GREEN_CONTAINER\" 2>/dev/null || true
                  sudo docker stop \"\$GREEN_CONTAINER\" 2>/dev/null && sudo docker rm -f \"\$GREEN_CONTAINER\" 2>/dev/null
                  exit 1
                fi

                echo \"대기 중... (\$i/36) status=\$STATUS\"
                sleep 5
              done

              # ── Blue 슬롯 중지 (인프라는 유지) ──
              if [[ \"\$ACTIVE_SLOT\" != 'none' ]]; then
                OLD_CONTAINER=\$(\$DC ps --format json 2>/dev/null | jq -sr \".[] | select(.Service == \\\"prod-\$BLUE_SLOT\\\") | .Name\")
                if [[ -n \"\$OLD_CONTAINER\" ]]; then
                  echo \"기존 슬롯(\$OLD_CONTAINER) 중지...\"
                  sudo docker stop \"\$OLD_CONTAINER\" 2>/dev/null && sudo docker rm -f \"\$OLD_CONTAINER\" 2>/dev/null
                fi
              fi

              sudo docker image prune -f
              echo '✅ Prod Blue-Green 배포 완료!'
            "
