name: Finders CD (Deploy to Prod)

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/finders-api
  CONTAINER_NAME: finders-api

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build without Test
        # CI에서 이미 테스트를 통과했다고 믿고, 배포 속도를 위해 테스트는 건너뜁니다.
        run: ./gradlew build -x test

      # 4. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Docker 이미지 빌드 및 푸시
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest

      # 6. GCP 인증 (Workload Identity 사용)
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      # 7. Google Cloud SDK 설정
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'

      # 8. IAP를 통해 파일 전송 및 배포 실행
      - name: 'Deploy to GCE via IAP'
        run: |
          # A. 서버 디렉토리는 sudo로 만들고, 소유권 변경은 생략해도 됩니다.
          gcloud compute ssh ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="sudo mkdir -p /projects/Spring"
          
          # B. 파일을 목적지(/projects/Spring)가 아닌 '홈 디렉토리(~/)로' 전송합니다.
          # 홈 디렉토리는 로그인한 사용자에게 항상 쓰기 권한이 있어 절대 에러가 나지 않습니다.
          gcloud compute scp docker-compose.prod.yml ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }}:~/docker-compose.prod.yml \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet
          
          # C. 원격 명령어 실행
          gcloud compute ssh ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="
              # [변경 C] 홈에 안전하게 도착한 파일을 sudo 권한으로 목적지에 옮깁니다.
              sudo mv ~/docker-compose.prod.yml /projects/Spring/docker-compose.prod.yml
          
              cd /projects/Spring
          
              # [변경 D] 환경변수 파일도 sudo 권한으로 생성하기 위해 tee 명령어를 사용합니다.
              echo '${{ secrets.ENV_PROD }}' | sudo tee .env.prod > /dev/null
          
              # 배포 프로세스
              sudo docker compose -p finders-prod -f docker-compose.prod.yml pull
              sudo docker compose -p finders-prod -f docker-compose.prod.yml down
              sudo docker compose -p finders-prod -f docker-compose.prod.yml up -d
          
              echo '배포 후 Health Check 시작...'
              for i in {1..12}; do
                RESPONSE=\$(curl -s http://localhost:8080/api/actuator/health || true)
                if [[ \"\$RESPONSE\" == *\"UP\"* ]]; then
                  echo '✅ 운영 서버 정상 실행 확인!'
                  sudo docker image prune -f
                  exit 0
                fi
                echo \"대기 중... (\$i/12)\"
                sleep 5
              done
              exit 1
            "