name: Finders CD (Deploy to Prod)

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/finders-api
  CONTAINER_NAME: finders-api

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-prod
      cancel-in-progress: true
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build without Test
        # CIÏóêÏÑú Ïù¥ÎØ∏ ÌÖåÏä§Ìä∏Î•º ÌÜµÍ≥ºÌñàÎã§Í≥† ÎØøÍ≥†, Î∞∞Ìè¨ ÏÜçÎèÑÎ•º ÏúÑÌï¥ ÌÖåÏä§Ìä∏Îäî Í±¥ÎÑàÎúÅÎãàÎã§.
        run: ./gradlew build -x test

      # 4. Docker Hub Î°úÍ∑∏Ïù∏
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïãú
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest

      # 6. GCP Ïù∏Ï¶ù (Workload Identity ÏÇ¨Ïö©)
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      # 7. Google Cloud SDK ÏÑ§Ï†ï
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'

      # 8. Blue-Green Î∞∞Ìè¨ Ïã§Ìñâ
      - name: 'Deploy to GCE via IAP (Blue-Green)'
        run: |
          # A. ÏÑúÎ≤Ñ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          gcloud compute ssh ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="sudo mkdir -p /projects/Spring"

          # B-1. docker-compose.infra.yml Ï†ÑÏÜ°
          gcloud compute scp docker-compose.infra.yml ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }}:~/docker-compose.infra.yml \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet

          # B-2. docker-compose.prod.yml Ï†ÑÏÜ°
          gcloud compute scp docker-compose.prod.yml ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }}:~/docker-compose.prod.yml \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet

          # C. Blue-Green Î∞∞Ìè¨ Î™ÖÎ†πÏñ¥ Ïã§Ìñâ
          gcloud compute ssh ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="
              # ÌååÏùºÏùÑ Î™©Ï†ÅÏßÄÎ°ú Ïù¥Îèô
              sudo mv ~/docker-compose.infra.yml /projects/Spring/docker-compose.infra.yml
              sudo mv ~/docker-compose.prod.yml /projects/Spring/docker-compose.prod.yml

              cd /projects/Spring

              # Ïô∏Î∂Ä ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ ÏÉùÏÑ±
              sudo docker network create finders-network || true

              # ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº ÏÉùÏÑ±
              echo '${{ secrets.ENV_PROD }}' | sudo tee .env.prod > /dev/null

              # ‚îÄ‚îÄ ÌòÑÏû¨ ÌôúÏÑ± Ïä¨Î°Ø Í∞êÏßÄ ‚îÄ‚îÄ
              ACTIVE_SLOT=\$(sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml ps --format json 2>/dev/null | jq -sr '.[].Service' 2>/dev/null | grep -E 'prod-blue|prod-green' | head -1 || echo \"none\")
              if [[ \"\$ACTIVE_SLOT\" == \"prod-blue\" ]]; then
                GREEN_SLOT=\"green\"
                BLUE_SLOT=\"blue\"
              else
                GREEN_SLOT=\"blue\"
                BLUE_SLOT=\"green\"
              fi
              echo \"üîç Active: \$ACTIVE_SLOT ‚Üí New: \$GREEN_SLOT, Old: \$BLUE_SLOT\"

              # ‚îÄ‚îÄ ÏµúÏ¥à Î∞∞Ìè¨ Ïãú Î≤†Ïù¥Ïä§ Ïù∏ÌîÑÎùº ÏãúÏûë ‚îÄ‚îÄ
              if [[ \"\$ACTIVE_SLOT\" == \"none\" ]]; then
                echo \"üöÄ ÏµúÏ¥à Î∞∞Ìè¨: Î≤†Ïù¥Ïä§ Ïù∏ÌîÑÎùº ÏãúÏûë\"
                sudo docker compose --env-file .env.prod -f docker-compose.infra.yml up -d
                sleep 10
              fi

              # ‚îÄ‚îÄ ÏÉà Ïù¥ÎØ∏ÏßÄ Pull ‚îÄ‚îÄ
              sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml pull

              # ‚îÄ‚îÄ Green Ïä¨Î°Ø ÏãúÏûë ‚îÄ‚îÄ
              echo \"üü¢ Green Ïä¨Î°Ø(\$GREEN_SLOT) ÏãúÏûë\"
              sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml --profile \$GREEN_SLOT up -d

              # ‚îÄ‚îÄ Direct Health Check (Traefik Ïö∞Ìöå) ‚îÄ‚îÄ
              echo \"üíì Health Check ÏãúÏûë (direct container exec)...\"
              GREEN_CONTAINER=\$(sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml ps --format json 2>/dev/null | jq -sr '.[] | select(.Service | contains(\"prod-'\$GREEN_SLOT'\")) | .Name')
              for i in {1..20}; do
                if sudo docker exec \$GREEN_CONTAINER wget --spider -q http://localhost:8080/api/actuator/health; then
                  echo \"‚úÖ Green slot healthy\"
                  break
                fi
                if [ \$i -eq 20 ]; then
                  echo \"‚ùå Green health check failed\"
                  sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml --profile \$GREEN_SLOT stop
                  sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml --profile \$GREEN_SLOT rm -f
                  exit 1
                fi
                echo \"‚è≥ ÎåÄÍ∏∞ Ï§ë... (\$i/20)\"
                sleep 5
              done

              # ‚îÄ‚îÄ Blue Ïä¨Î°Ø Ï†ïÎ¶¨ ‚îÄ‚îÄ
              echo \"üîµ Blue Ïä¨Î°Ø(\$BLUE_SLOT) Ï†ïÎ¶¨\"
              sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml --profile \$BLUE_SLOT stop
              sudo docker compose --env-file .env.prod -f docker-compose.infra.yml -f docker-compose.prod.yml --profile \$BLUE_SLOT rm -f

              # ‚îÄ‚îÄ ÎØ∏ÏÇ¨Ïö© Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨ ‚îÄ‚îÄ
              sudo docker image prune -f
              echo \"‚úÖ Blue-Green Î∞∞Ìè¨ ÏôÑÎ£å!\"
            "