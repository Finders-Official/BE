name: Finders CD (Deploy to Dev)

on:
  push:
    branches: [ "develop" ]

concurrency:
  group: deploy-dev
  cancel-in-progress: true

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/finders-api
  CONTAINER_NAME: finders-dev-api

permissions:
  contents: read
  id-token: write # WIF 사용을 위해 반드시 필요합니다.

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build without Test
        run: ./gradlew build -x test

      # 4. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Docker 이미지 빌드 및 푸시 (dev 태그)
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:dev

      # 6. GCP 인증 (JSON 키 대신 Workload Identity 사용)
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      # 7. Google Cloud SDK 설정
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'

      # 8. IAP를 통해 파일 전송 및 Blue-Green 배포 실행
      - name: 'Deploy to GCE via IAP'
        run: |
          # A. 서버 디렉토리 생성
          gcloud compute ssh ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="sudo mkdir -p /projects/Spring"

          # B. 파일을 홈 디렉토리(~)로 전송 (권한 에러 방지)
          gcloud compute scp docker-compose.infra.yml docker-compose.dev.yml \
            ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }}:~ \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet

          # C. Blue-Green 배포 실행
          gcloud compute ssh ${{ secrets.GCE_USER }}@${{ secrets.GCE_NAME }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="
              # 홈에 있는 파일을 sudo로 목적지 이동
              sudo mv ~/docker-compose.infra.yml /projects/Spring/docker-compose.infra.yml
              sudo mv ~/docker-compose.dev.yml /projects/Spring/docker-compose.dev.yml

              cd /projects/Spring

              # Docker 네트워크 생성 (없을 경우)
              sudo docker network create finders-network || true

              # 환경변수 파일 생성
              echo '${{ secrets.ENV_DEV }}' | sudo tee .env.dev > /dev/null

              # ── Blue-Green 슬롯 감지 ──
              ACTIVE_SLOT=\$(sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml ps --format json | jq -r '.[].Service' | grep -E 'dev-blue|dev-green' | head -1 || echo 'none')

              if [[ \"\$ACTIVE_SLOT\" == 'dev-blue' ]]; then
                GREEN_SLOT='green'
                BLUE_SLOT='blue'
              else
                GREEN_SLOT='blue'
                BLUE_SLOT='green'
              fi

              echo \"현재 활성 슬롯: \$ACTIVE_SLOT\"
              echo \"새 슬롯(Green): dev-\$GREEN_SLOT\"
              echo \"기존 슬롯(Blue): dev-\$BLUE_SLOT\"

              # ── 최초 배포: 베이스 인프라 시작 ──
              if [[ \"\$ACTIVE_SLOT\" == 'none' ]]; then
                echo '최초 배포 감지 - 베이스 인프라 시작...'
                sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d traefik cloudflared
                sleep 10
              fi

              # ── 이미지 Pull ──
              sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml pull

              # ── Green 슬롯 시작 ──
              echo \"Green 슬롯(dev-\$GREEN_SLOT) 시작...\"
              sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile \$GREEN_SLOT up -d

              # ── Health Check (직접 컨테이너 실행) ──
              echo 'Health Check 시작...'
              GREEN_CONTAINER=\$(sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml ps --format json | jq -r '.[] | select(.Service | contains(\"dev-'\$GREEN_SLOT'\")) | .Name')

              for i in {1..20}; do
                if sudo docker exec \$GREEN_CONTAINER wget --spider -q http://localhost:8080/api/actuator/health; then
                  echo '✅ Green 슬롯 정상 확인!'
                  break
                fi
                if [ \$i -eq 20 ]; then
                  echo '❌ Green Health Check 실패 - 롤백 진행'
                  sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile \$GREEN_SLOT stop
                  sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile \$GREEN_SLOT rm -f
                  exit 1
                fi
                echo \"대기 중... (\$i/20)\"
                sleep 5
              done

              # ── Blue 슬롯 중지 및 제거 ──
              if [[ \"\$ACTIVE_SLOT\" != 'none' ]]; then
                echo \"기존 슬롯(dev-\$BLUE_SLOT) 중지...\"
                sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile \$BLUE_SLOT stop
                sudo docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile \$BLUE_SLOT rm -f
              fi

              # ── 정리 ──
              sudo docker image prune -f
              echo '✅ Dev Blue-Green 배포 완료!'
            "